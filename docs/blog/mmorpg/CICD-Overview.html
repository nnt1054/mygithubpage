<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google" content="notranslate" />

  <title>Neil Toledo - Overview</title>
  <meta name="description" content="Github">

  <link rel="icon" href="/assets/images/me.jpg">
  <link rel="shortcut icon" href="/assets/images/me.jpg">
  <link rel="apple-touch-icon" href="/assets/images/me.jpg">

  <link rel="stylesheet" href="/assets/css/rouge.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <!--<link href='https://fonts.googleapis.com/css?family=Lexend+Deca' rel='stylesheet'>-->
  <!--<link href='https://fonts.googleapis.com/css?family=Livvic' rel='stylesheet'>-->
  <!--<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>-->
  <!--<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>-->
  <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
  <link href='https://fonts.googleapis.com/css?family=Comfortaa' rel='stylesheet'>
</head>

  <body>
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <link rel="stylesheet" href="/assets/css/documentation.css">

    <div id='top-nav-container'>

	<div id='nav-left'>
		<a href='/' class='img-container'> <img id="home-img" src="/assets/images/me.jpg"> </a>
		<h1> 2DMMORPG Documentation </h1>
	</div> 

	<div id='nav-right'>
		<a class="rect-btn" href="/portfolio"> <span>portfolio</span> </a>
		<a class="rect-btn" href="/blog/projects"> <span>blog</span> </a>
		<a class="rect-btn" href="/assets/images/resume.pdf"> <span>resume</span> </a>
	</div>

</div>

<style>

	#top-nav-container {
		display: flex;
		flex-direction: row;

		justify-content: space-between;

	 	max-width: 1280px;
		width: 80vw;

		position: absolute;
		margin: 0px auto;
		top: 32px;
		left: 0px;
		right: 0px;
	}

	#home-img {
		height: 64px;
		width: 64px;
		border-radius: 50%;
		border: 2px black solid;
	}

	#nav-left, #nav-right {
		display: flex;
		flex-direction: row;
	}

	#nav-left > * {
		margin-top: auto;
		margin-bottom: auto;
	}

	#nav-right > * {
		margin-top: auto;
		margin-bottom: auto;
	}

	#nav-left > h1 {
		margin-left: 12px;
		cursor: default;
	}

	.sm-link {
		font-size: 10pt;
		padding: 6px 8px;
	}

	.img-container {
		display: flex;
	}

	.rect-btn {
		width: 128px;
		margin-left: 10px;
		margin-right: 10px;
		border: 2px solid black;
		border-radius: 6px;
		background: white;
		box-shadow: 5px 5px;
		transform: translateY(-5px) translateX(-5px);
		cursor: pointer;
		height: 32px;
		display: flex;
		z-index: 10;
		color: black;
	}

	.rect-btn:hover {
		transition: 0.1s;
		box-shadow: 2px 2px;
		transform: translateY(-2px) translateX(-2px);
		text-decoration: none;
	}
	
	.rect-btn > * {
		margin: auto;
	}


@media (max-width: 1024px) {
	#top-nav-container {
		position: absolute;
	}

	#nav-right {
		display: none;
	}

}

</style>

    <div id="page-container">

        <div id="nav-container">
            <span> Pages </span>
            <ul class='nav-page-list'>

                

                

                

                <!-- get posts without parent -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <a href="/blog/mmorpg/mmorpg-project-overview"> • Project Overview </a>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <a href="/blog/mmorpg/General-Architecture"> • General Architecture </a>
                    
                
                    
                        <a href="/blog/mmorpg/Scrum-Board"> • Scrum Board [WIP] </a>
                    
                

                <!-- get posts with parent tag -->
                
                    
                    

                    

                    
                    <span> Component Design Documents </span>
                    <ul class='nav-page-list'>
                    
                        
                    
                        
                            <a href="/blog/mmorpg/Game-Client"> • Game Client </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Primary-Gateway-Server"> • Primary Gateway Server </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Server-Manager"> • Server Manager </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Game-Server-Instance"> • Game Server Instance </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Social-Services-Server"> • Social API Server </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Account-Data-API"> • Account Data API </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Character-Data-API"> • Character Data API </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Questing-API"> • Questing API </a>
                        
                    
                        
                            <a href="/blog/mmorpg/CDN-Asset-Server"> • CDN Asset Server </a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    </ul>
                    

                
                    
                    

                    

                    
                    <span> Game Design Documents </span>
                    <ul class='nav-page-list'>
                    
                        
                            <a href="/blog/mmorpg/Game-Design-Overview"> • Game Design Overview </a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    </ul>
                    

                
                    
                    

                    

                    
                    <span> CI/CD and Infrastructure </span>
                    <ul class='nav-page-list'>
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            <a href="/blog/mmorpg/CICD-Overview"> • Overview </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Configuration-and-Setup"> • Configuration/Setup </a>
                        
                    
                        
                    
                        
                            <a href="/blog/mmorpg/Polling-Server"> • Polling Server </a>
                        
                    
                        
                            <a href="/blog/mmorpg/Helm-API"> • Helm API </a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    </ul>
                    

                


            </ul>
            
        </div>

        <div id="page-content" itemprop="articleBody">
            <header class="post-header">
                <h1 class="post-title" itemprop="name headline">Overview</h1>
<!--                 <p class="post-meta"><time datetime="2020-04-29T00:00:00-07:00" itemprop="datePublished">Apr 29, 2020</time></p>
 -->            </header>
            <p><a href="https://github.com/nnt1054/mmorpg-cicd">Github</a></p>

<h3 id="introduction">Introduction:</h3>

<p>This is a custom CI/CD system (sub-)project put together as a learning experience as well as tool for developing this mmorpg.  The system is primarily focused on continous delivery and automatically upgrades both docker images and helm chart deployments upon new available semver or staging versions.
A general theme/goal of the project was to create a “portable” CI/CD system that can be quickly torn down and rebuilt.  The system is entirely self hosted and all the necessary configuration exists within the project.  This is primarily faciliated through the use of <a href="https://github.com/Praqma/helmsman">helmsman</a>, an “Application as Code” tool, that allows for deploying and maintaining several helm charts.</p>

<h3 id="overview">Overview:</h3>
<p class="column"><a href="/assets/images/mmorpg_pictures/cicd-overview-01.png"><img src="/assets/images/mmorpg_pictures/cicd-overview-01.png" alt="cicd-overview" style="width: 100%" /></a></p>

<p><br /></p>

<h3 id="how-it-works">How it Works:</h3>

<h4 id="docker-image-updates">Docker Image Updates</h4>
<ol>
  <li>Once the developers have ensured their updates are working in their local environment, they can make a PR and merge their changes to their master/prod github branch.</li>
  <li>The Polling Server will detect the new PR merge, call <code class="highlighter-rouge">docker build</code> on the github repo with a ‘staging’ tag and <code class="highlighter-rouge">docker push</code> the built image to the docker registry.</li>
  <li>Keel.sh will detect the new available ‘staging’ image, and automatically upgrade the corresponding (staging) helm chart deployment on the cluster</li>
  <li>Once the developers have verified there are no issues with the staging deployemnt, they can add a new semver tag to the github repository.
    <ul>
      <li>(eventually we’ll have tests to automatically check staging/prod deployments)</li>
      <li>the same cycle will repeat with the polling server and keel.sh, except using the new semver tag and will upgrade the production deployment.</li>
    </ul>
  </li>
</ol>

<h4 id="helm-chart-updates">Helm Chart Updates</h4>
<ol>
  <li>Once the developers have ensured their updates are working in their local environment, they can make a PR and merge their helm chart updates to the master/prod github branch.
    <ul>
      <li>(more on github repo structure later)</li>
    </ul>
  </li>
  <li>After merging, the developers can run <code class="highlighter-rouge">helm push &lt;github-repo&gt; --version staging</code>, which will package and push the new helm chart to the chartmuseum repository.</li>
  <li>The Polling Server will detect the helm chart version, and will ping the <code class="highlighter-rouge">/apply</code> endpoint of the running Helm API.</li>
  <li>The Helm API searches for the <code class="highlighter-rouge">helmsman-cronjob</code> resource on the cluster, and manually create a kuberenetes job from its job template.</li>
  <li>The kubernetes job will run a <code class="highlighter-rouge">helmsman --apply -f &lt;dss&gt;.yaml</code> command, which will apply new helm chart upgrades to the cluster.</li>
  <li>Once the developers have verified there are no issues with the staging deployment, they can make another <code class="highlighter-rouge">helm push</code> call with <code class="highlighter-rouge">--version &lt;semver tag&gt;</code>, and the process will repeat with the updated version.
    <ul>
      <li>Note: major semver updates will have to be approved by the SRE/DevOps team, and must be updated in the helmsman dss files.</li>
    </ul>
  </li>
</ol>

<h4 id="rollbacks">Rollbacks:</h4>

<h5 id="production">Production</h5>
<ul>
  <li>tag a previous commit that you want to rollback to with an updated semver
    <ul>
      <li>the polling server and keel.sh will detect the new tag and rollback the update</li>
    </ul>
  </li>
</ul>

<h5 id="staging">Staging</h5>
<ul>
  <li>TBD</li>
</ul>

<p><br /></p>

<h3 id="component-descriptions">Component Descriptions</h3>

<h4 id="polling-server">Polling Server</h4>
<ul>
  <li>polls the github events api for provided repositories until either new changes or new tags are detected
    <ul>
      <li>after detecting new events, will call docker build and docker push on the provided repository</li>
      <li>will tag the docker image as staging for repo changes or use a semver tag for new tag events</li>
    </ul>
  </li>
  <li>polls the helm chart repository for new chart updates
    <ul>
      <li>after detecting new helm chart verseions, will send a request to the <code class="highlighter-rouge">/apply</code> endpoint of the helm-api</li>
    </ul>
  </li>
</ul>

<h4 id="helm-api">Helm API</h4>
<ul>
  <li>when the <code class="highlighter-rouge">/apply</code> endpoint is pingged, will create a kubernetes job using an existing cronjob as a template
    <ul>
      <li>the job created will make a <code class="highlighter-rouge">helmsman --apply -f &lt; dss &gt;.yaml</code> call and apply helm chart updates to the cluster</li>
    </ul>
  </li>
  <li>(name subject to change)</li>
</ul>

<h4 id="keelsh">Keel.sh</h4>
<ul>
  <li><a href="https://keel.sh/">Keel.sh</a> is an open source “Kubernetes Operator” that detects new available docker image versions and automatically updates the deployment based on provided configuration.</li>
  <li>I contributed to the open source project by adding Helm v3 support :)</li>
</ul>

<h4 id="docker-registry">Docker Registry</h4>
<ul>
  <li>a basic docker registry for holding docker images deployed from the <code class="highlighter-rouge">stable/docker-registry</code> chart.</li>
  <li>uses minio s3 buckets for storage</li>
</ul>

<h4 id="chartmuseum">ChartMuseum</h4>
<ul>
  <li>a basic helm chart repository for holding packaged helm chart files deployed from the <code class="highlighter-rouge">stable/chartmuseum</code> chart.</li>
  <li>uses minio s3 buckets for storage</li>
</ul>

<h4 id="helm-push">Helm Push</h4>
<ul>
  <li><a href="https://github.com/nnt1054/helm-push">Helm Push</a> is a helm plugin that packages and pushes helm charts to provided helm chart repository</li>
  <li>forked the original plugin and made changes to allow for pushing helm charts via github repo url</li>
</ul>

<!--

### Configuration and Setup

Here's a quick list of everything that needs configuring:
* github repo pipelines
* helm chart pipelines
* dss files
* host names(?)

#### TOC

This page is the *entire* general overview, so include everything needed to understand what the system does

* Introduction/Overview
* diagram/flowchart of what exactly is going on
* outlining general role of each component (polling-server, helm-api, keel)
* explanation of helmsman and the corresponding dss files
	* explanation of all the other necessary "cluster resources"
* configuration

* configuration
	* organization of files
	* snapshot of the kuberentes cluster


-->

<p><br /></p>

        </div>

    </div>
</article>
  </body>


  <script src="/assets/js/jquery-3.3.1.min.js"></script>
  <script src="/assets/js/main.js"></script>
  <link rel="stylesheet" href="/assets/css/mobile.css">
</html>